<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Research Office ‚Äî zeta-zero-cafe (TEST)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/css/10-components/research-office.css" />
  <script src="/cafes/zeta-zero-cafe/notebook/math/mathconfig.js"></script>
  <style>
    :root { color-scheme: dark; }
    body { background:#0b0f14; }
    .wrap { max-width: 1200px; margin: 18px auto; padding: 0 12px; }
    .muted { color:#9aa7b2; }

    #gridStub { background:#0c1217; border:1px solid var(--line); border-radius:10px; padding:8px; }
    #gridViewport { width: var(--ro-left-stage, 340px); height: 420px; overflow:auto; background:#0b0f14; border-radius:8px; }
    #pageImg { width:100%; display:block; }

    .toolbar-row { display:flex; align-items:center; gap:8px; margin:6px 0 2px; }
    .tiny { font-size: 12px; }
    #status { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#9aa7b2; margin-top:6px; }

    #pagesBar { display:flex; gap:10px; overflow:auto; padding:10px 6px; }
    .thumb { position:relative; width:96px; height:128px; border:1px solid #26323f; border-radius:10px; background:#0e141b; display:flex; align-items:center; justify-content:center; cursor:pointer; flex: 0 0 auto; }
    .thumb img { max-width:90%; max-height:90%; display:block; }
    .thumb .tag { position:absolute; left:6px; top:6px; font-size:12px; background:#0b0f14; padding:1px 6px; border-radius:10px; border:1px solid #26323f; }
    .thumb .kill { position:absolute; right:6px; top:6px; font-size:12px; background:#40222a; padding:0 6px; border-radius:10px; border:1px solid #70333e; display:none; }
    .thumb.active { outline: 3px solid #4ea9ff; }
    .thumb.primary { outline: 4px solid #f1a500; }
    .thumb:not(.primary) .kill { display:block; }

    #memoPreview { background:#0b0f14; border:1px dashed #223; border-radius:10px; padding:12px; margin-top:12px; }
  </style>
</head>
<body class="ro">
  <div class="wrap">
    <a class="ro-back" href="javascript:history.back()">‚Üê Back</a>
    <h1>Research Office ‚Äî <span class="mono">zeta-zero-cafe</span> (TEST)</h1>

    <main class="ro-main">
      <section class="left">
        <div id="ro-stage" class="card">
          <div id="gridStub">
            <div id="gridViewport"><img id="pageImg" alt="source page" /></div>
            <div class="toolbar-row">
              <button id="btnPrev">‚óÄ</button>
              <button id="btnHome">primary</button>
              <button id="btnNext">‚ñ∂</button>
              <span class="tiny muted" id="gridPageLabel"></span>
              <div style="flex:1"></div>
              <button id="btnAdd">[Add page]</button>
            </div>
            <div id="status" aria-live="polite"></div>
          </div>
        </div>
      </section>

      <section class="right">
        <div class="card">
          <h3>Pages referenced in memo</h3>
          <div id="pagesBar" aria-live="polite"></div>
        </div>

        <div class="card">
          <h3>Paragraph preview <span class="tiny muted" id="paraBadge"></span></h3>
          <div class="toolbar-row">
            <label>Chapter:
              <select id="selChapter"></select>
            </label>
            <label>Paragraph:
              <select id="selPara"></select>
            </label>
          </div>
          <div id="paraPreview" class="mono" style="white-space:pre-wrap; min-height:120px;"></div>
        </div>

        <div class="card">
          <h3>Memo to self (Markdown + LaTeX)</h3>
          <div class="toolbar-row">
            <button data-msg="(B)old" class="tiny">B</button>
            <button data-msg="italic" class="tiny">i</button>
            <button data-msg="link" class="tiny">üîó</button>
            <button data-msg="\\(x\\)" class="tiny">\\(x\\)</button>
            <button id="btnPreview" class="tiny">Preview</button>
          </div>
          <textarea id="memoTA" rows="10" class="mono" style="width:100%;">State the issue, desired change, and rationale‚Ä¶</textarea>
          <div class="toolbar-row">
            <button class="tiny" data-alert="Saving draft">Save draft</button>
            <button class="tiny" data-alert="Saving version">Save version</button>
            <button class="tiny" data-alert="Exporting memo JSON">Export memo JSON</button>
            <button class="tiny" data-alert="Export ALL drafts">Export ALL drafts</button>
            <button class="tiny" data-alert="Choosing File">Choose File</button>
            <button class="tiny" data-alert="Submitting via Discord">Submit via Discord</button>
          </div>
          <div id="memoPreview" class="mono tiny"></div>
        </div>

        <div class="card">
          <h3>Versions (snapshots for this memo)</h3>
          <div class="tiny muted">No snapshots yet.</div>
        </div>
        <div class="card">
          <h3>Recent drafts (this browser)</h3>
          <div class="tiny muted">‚Äî</div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const $ = (s,d=document)=>d.querySelector(s);
    const $$=(s,d=document)=>Array.from(d.querySelectorAll(s));
    const pad3 = n => String(n).padStart(3,'0');
    const zeroPadSrc = p => `/cafes/zeta-zero-cafe/sources/thumbs/page-${pad3(p)}.jpg`;
    function status(msg){ $('#status').textContent = msg || ''; }

    async function loadScriptOnce(src) {
      return new Promise((res,rej)=>{
        const url = new URL(src, location.href).toString();
        if ([...document.scripts].some(s=>s.src===url)) return res();
        const s=document.createElement('script'); s.src=url; s.async=true;
        s.onload=res; s.onerror=()=>rej(new Error('failed '+src));
        document.head.appendChild(s);
      });
    }
    async function ensureMarked(){
      if (window.marked) return;
      try { await loadScriptOnce('/js/marked.min.js'); if (window.marked) return; } catch {}
      await loadScriptOnce('https://cdn.jsdelivr.net/npm/marked@12/marked.min.js');
    }
    async function ensureMathJax(){
      if (window.MathJax?.typesetPromise) return;
      if (!window.MathJax) window.MathJax = { tex:{inlineMath:[['\\(','\\)'],['$','$']]}, loader:{load:['[tex]/ams','[tex]/textmacros']} };
      const srcs = ['/js/mathjax/es5/tex-chtml.js','https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js'];
      for (const s of srcs){ try { await loadScriptOnce(s); if (MathJax.startup?.promise) await MathJax.startup.promise; if (MathJax.typesetPromise) return; } catch{} }
    }
    function normalizeFencedMath(md){
      return md.replace(/```\s*math\s*\r?\n([\s\S]+?)\r?\n```/gi,(_,b)=>`$$${b}$$`);
    }
    async function renderMdLatex(md, out){
      md = normalizeFencedMath(md);
      const store=[]; const ph=i=>`<span data-tex="${i}"></span>`;
      md = md.replace(/\$\$([\s\S]+?)\$\$/g,(_,b)=>{store.push('$$'+b+'$$');return ph(store.length-1);});
      md = md.replace(/(^|[^\$])\$(?!\$)([^$\n]+?)\$(?!\$)/g,(m,pre,b)=>{store.push('$'+b+'$');return pre+ph(store.length-1);});
      await ensureMarked(); out.innerHTML = marked.parse(md);
      out.querySelectorAll('span[data-tex]').forEach(s=>{const i=+s.dataset.tex; s.replaceWith(document.createTextNode(store[i]||''));});
      await ensureMathJax(); if (MathJax.typesetClear) MathJax.typesetClear([out]); if (MathJax.texReset) MathJax.texReset();
      if (MathJax.typesetPromise) await MathJax.typesetPromise([out]); else MathJax.typeset([out]);
    }

    const STARTS = {
      "notebook/chapter-1-the-basel-problem.html": 7,
      "notebook/chapter-2-the-spatial-aspect-of-zet.html": 11,
      "notebook/chapter-3-the-primorial-function.html": 23,
      "notebook/chapter-4-the-triangular-numbers.html": 31,
      "notebook/chapter-5-chords.html": 51,
      "notebook/chapter-6-a-cartesian-m-brane-monos.html": 63,
      "notebook/chapter-7-quadrature-geometric-framework.html": 73,
      "notebook/chapter-8-spectrum-of-volume.html": 109
    };
    const CHAPTERS = Object.keys(STARTS).map(p => ({ path:p, title:'Chapter '+p.match(/chapter-(\d+)/)[1]+' ‚Äî '+p.replace(/^notebook\/chapter-\d+-|\.html$/g,'').replace(/-/g,' ') }));

    let state = {
      chapter: CHAPTERS[0].path,
      paraId: '',
      primaryPage: STARTS[CHAPTERS[0].path],
      activePage: STARTS[CHAPTERS[0].path],
      pages: new Set(),
      maxPages: 126 // <- numeric navigation range for Prev/Next in this TEST page
    };

    function fillChapters(){
      $('#selChapter').innerHTML = CHAPTERS.map(c=>`<option value="${c.path}">${c.title}</option>`).join('');
      $('#selChapter').value = state.chapter;
    }

    async function loadChapterAndFillParas(){
      $('#selPara').innerHTML = `<option>loading‚Ä¶</option>`;
      const html = await (await fetch('/cafes/zeta-zero-cafe/'+state.chapter, {cache:'no-store'})).text();
      const doc = new DOMParser().parseFromString(html,'text/html');
      const list = Array.from(doc.querySelectorAll('pre.osf'));
      const opts = list.map((pre,i)=>({ id: pre.id || `osf-${i+1}`, label:`Paragraph ${i+1}`, page:Number(pre.dataset.page||'')||undefined }));
      $('#selPara').innerHTML = opts.map(o=>`<option value="${o.id}" data-page="${o.page||''}">${o.label}</option>`).join('');
      state.paraId = opts[0]?.id || ''; $('#selPara').value = state.paraId;
      state.primaryPage = Number($('#selPara').selectedOptions[0].dataset.page || STARTS[state.chapter] || 1);
      state.activePage  = state.primaryPage;
      await showParagraphPreview(doc);
      updatePrimaryThumb();
      recomputePagesFromMemo();
    }
    async function showParagraphPreview(parsedDoc){
      const doc = parsedDoc || new DOMParser().parseFromString(await (await fetch('/cafes/zeta-zero-cafe/'+state.chapter)).text(),'text/html');
      const pre = doc.getElementById(state.paraId);
      $('#paraBadge').textContent = pre ? `#${state.paraId}` : '(not found)';
      $('#paraPreview').textContent = pre ? pre.textContent.trim() : '(paragraph not found)';
      await ensureMathJax(); if (MathJax.typesetPromise) await MathJax.typesetPromise([$('#paraPreview')]);
    }

    function parsePagesFromMemo(){
      const text = $('#memoTA').value;
      const pages = new Set();
      const re = /\[mm\|p(\d+)=/g; let m;
      while((m=re.exec(text))) pages.add(Number(m[1]));
      pages.delete(state.primaryPage);
      return pages;
    }
    function recomputePagesFromMemo(){
      state.pages = parsePagesFromMemo(); renderPagesBar();
    }
    function renderPagesBar(){
      const all = [state.primaryPage, ...Array.from(state.pages)];
      const sorted = Array.from(new Set(all)).sort((a,b)=>a-b);
      const bar = $('#pagesBar'); bar.innerHTML = '';
      sorted.forEach(p=>{
        const div = document.createElement('div');
        div.className = 'thumb'+(p===state.primaryPage?' primary':'')+(p===state.activePage?' active':'');
        div.dataset.page = p;
        div.innerHTML = `<span class="tag">p.${p}</span>${p!==state.primaryPage?'<span class="kill">x</span>':''}`;
        const img=document.createElement('img'); img.alt=`page ${p}`; img.src=zeroPadSrc(p);
        img.onerror=()=>img.replaceWith(document.createTextNode('missing'));
        div.appendChild(img);
        div.onclick = ev=>{
          if (ev.target.classList.contains('kill')){
            const t=$('#memoTA').value;
            const pruned=t.replace(new RegExp(String.raw`\[mm\|p${p}=.+?\]`,'g'),'');
            $('#memoTA').value=pruned; state.pages.delete(p);
            renderPagesBar(); if (state.activePage===p) updateViewerPage(state.primaryPage);
            return;
          }
          state.activePage=p; updateViewerPage(p); renderPagesBar();
        };
        bar.appendChild(div);
      });
      const active=bar.querySelector('.thumb.active'); if(active) active.scrollIntoView({inline:'center',behavior:'smooth'});
    }
    function updatePrimaryThumb(){ updateViewerPage(state.primaryPage); renderPagesBar(); }
    function updateViewerPage(p){ p=Math.max(1,Math.min(state.maxPages,p)); state.activePage=p; $('#pageImg').src = zeroPadSrc(p); $('#gridPageLabel').textContent = `p.${p}`; }

    // ---- Prev/Next now step numerically (independent of referenced set) ----
    $('#btnPrev').onclick = ()=>{ updateViewerPage(state.activePage - 1); renderPagesBar(); };
    $('#btnNext').onclick = ()=>{ updateViewerPage(state.activePage + 1); renderPagesBar(); };
    $('#btnHome').onclick = ()=>{ updateViewerPage(state.primaryPage); renderPagesBar(); };

    $('#btnAdd').onclick = ()=>{
      const p=state.activePage; if (p===state.primaryPage){ status('Primary is always present; no token added.'); return; }
      if (!$('#memoTA').value.includes(`[mm|p${p}=`)){
        $('#memoTA').value += ($('#memoTA').value.endsWith('\n')?'':'\n') + `[mm|p${p}=x,y]\n`;
        state.pages.add(p); renderPagesBar();
      }
    };

    $('#btnPreview').onclick = async()=>{ await renderMdLatex($('#memoTA').value,$('#memoPreview')); };
    $$('button[data-alert]').forEach(b=>b.addEventListener('click',()=>alert(b.dataset.alert)));
    $('#memoTA').addEventListener('input',recomputePagesFromMemo);

    (async function init(){
      $('#selChapter').innerHTML = Object.keys(STARTS).map(p=>`<option value="${p}">${'Chapter '+p.match(/chapter-(\d+)/)[1]+' ‚Äî '+p.replace(/^notebook\/chapter-\d+-|\.html$/g,'').replace(/-/g,' ')}</option>`).join('');
      $('#selChapter').value = state.chapter;
      await loadChapterAndFillParas();
      $('#selChapter').onchange = async e=>{ state.chapter=e.target.value; await loadChapterAndFillParas(); };
      $('#selPara').onchange = async e=>{
        state.paraId=e.target.value;
        const pg=Number(e.target.selectedOptions[0].dataset.page||STARTS[state.chapter]||1);
        state.primaryPage=Number.isFinite(pg)?pg:1; updateViewerPage(state.primaryPage);
        await showParagraphPreview();
        recomputePagesFromMemo();
      };
      status(`Loaded thumbnail p.${state.primaryPage}.`);
    })();
  </script>
</body>
</html>

