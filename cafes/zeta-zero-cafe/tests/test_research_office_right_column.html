<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Research Office — zeta-zero-cafe (TEST)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/css/bundle.css?v=1" rel="stylesheet" />
  <script src="/cafes/zeta-zero-cafe/notebook/math/mathconfig.js"></script>
  <script defer id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <style>
    :root { --thumbW: 110px; --thumbH: 150px; }
    body { padding: 16px; }
    .wrap { display: grid; grid-template-columns: 320px 1fr; gap: 18px; }
    .card { background: var(--card); border:1px solid var(--line); border-radius:10px; padding:12px; }
    .left .viewer { height: 440px; display:flex; align-items:center; justify-content:center; overflow:auto; background:#0c1217; border-radius:8px; border:1px solid var(--line); }
    .viewer img { max-width:100%; height:auto; display:block; }
    .viewer-ctrls { display:flex; gap:8px; margin-top:10px; }
    .viewer-ctrls button { min-width:64px; }
    .refstrip { display:flex; gap:12px; overflow-x:auto; padding:6px 2px; }
    .ref { position:relative; width:var(--thumbW); height:var(--thumbH); border-radius:10px; border:2px solid var(--line); background:#0c1217; display:flex; align-items:center; justify-content:center; flex:0 0 auto; }
    .ref.primary { border:4px solid #f6b73c; } /* thicker orange */
    .ref.active  { box-shadow:0 0 0 3px rgba(90,200,255,.35) inset; }
    .ref img { width:calc(var(--thumbW) - 22px); height:auto; border-radius:6px; }
    .badge { position:absolute; top:4px; left:6px; background:#111a; color:#fff; font-size:11px; padding:2px 6px; border-radius:6px; }
    .ref .kill { position:absolute; top:4px; right:4px; background:#2b0d11; border:1px solid #933; color:#f7b; width:20px; height:20px; font-size:12px; border-radius:6px; line-height:18px; text-align:center; cursor:pointer; }
    .ref.primary .kill { display:none; } /* cannot remove primary */
    .row { display:grid; grid-template-columns: 1fr; gap:12px; }
    .hdr { display:flex; align-items:center; gap:10px; }
    .hdr small { opacity:.6; }
    .tiny { font-size:12px; opacity:.65; }
    textarea { width:100%; min-height:160px; resize:vertical; }
    .token-chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .chip { font-size:12px; border:1px solid var(--line); border-radius:999px; padding:2px 8px; background:#10161d; }
    .chip.hot { background:#0b2a3a; border-color:#39a0db; color:#cfefff; }
    #status { font-size:12px; opacity:.7; margin-top:6px; }
    .controls-inline { display:flex; align-items:center; gap:8px; }
    select, button { height:28px; }
    .spaced { margin-top:12px; }
  </style>
</head>
<body>
  <h1>Research Office — zeta-zero-cafe (TEST)</h1>

  <div class="wrap">
    <div class="left card">
      <div class="hdr"><strong>Grid Stub (page viewer)</strong></div>
      <div class="viewer"><img id="viewerImg" alt="page thumbnail" /></div>
      <div class="viewer-ctrls">
        <button id="btnPrev">◀</button>
        <button id="btnPrimary">primary</button>
        <button id="btnNext">▶</button>
        <button id="btnAdd">[Add page]</button>
      </div>
      <div id="status" class="tiny">—</div>
    </div>

    <div class="right row">
      <div class="card">
        <div class="hdr"><strong>Pages referenced in memo</strong></div>
        <div id="refstrip" class="refstrip"></div>
      </div>

      <div class="card">
        <div class="hdr"><strong>Paragraph preview</strong><small id="paraTag">#—</small></div>
        <div id="paraPreview" class="spaced tiny">This test stub focuses on right-column logic.</div>
      </div>

      <div class="card">
        <div class="hdr"><strong>Memo to self (Markdown + LaTeX)</strong></div>
        <!-- NOTE: start with EMPTY memo; no primary token at boot -->
        <textarea id="memoTA"></textarea>
        <div id="chips" class="token-chips"></div>

        <div class="spaced controls-inline">
          <button id="btnSaveDraft">Save draft</button>
          <button id="btnSaveVersion">Save version</button>
          <button id="btnExportJSON">Export memo JSON</button>
          <button id="btnExportAll">Export ALL drafts</button>
          <button id="btnChoose">Choose File</button>
          <button id="btnDiscord">Submit via Discord</button>
        </div>
      </div>

      <div class="card">
        <div class="hdr"><strong>Rendered output (test-only)</strong></div>
        <div id="renderOut" class="spaced tiny">—</div>
      </div>
    </div>
  </div>

  <script>
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const pad3 = n => String(n).padStart(3,'0');
  const setStatus = m => $('#status').textContent = m;

  const primaryPage = 7;
  let currentPage = primaryPage;

  // Token grammar
  const tokenRE = /\[(?<del>del\])?mm\|p(?<page>\d+)\s*=\s*([^\]\n]+)\]/g;

  function parseTokens(text) {
    tokenRE.lastIndex = 0;
    const items = [];
    let m;
    while ((m = tokenRE.exec(text))) {
      items.push({ raw:m[0], start:m.index, end:m.index+m[0].length, page:+m.groups.page, deleted:!!m.groups.del });
    }
    return items;
  }
  const hasLiveFor = (toks, p) => toks.some(t => t.page===p && !t.deleted);

  function markDeletedForPage(text, page) {
    return text.replace(tokenRE, (full, del, pg) => {
      const p = +pg;
      if (p===page && !del) return full.replace('[mm|','[del]mm|');
      return full;
    });
  }

  function reinstateForPage(text, page) {
    return text.replace(tokenRE, (full, del, pg) => {
      const p = +pg;
      if (p===page && del) return full.replace('[del]mm|','[mm|');
      return full;
    });
  }

  function addTokenIfNeeded(text, page) {
    if (page===primaryPage) return text;             // never tokenise primary
    const toks = parseTokens(text);
    if (hasLiveFor(toks, page)) return text;
    if (toks.some(t => t.page===page && t.deleted)) return reinstateForPage(text, page);
    const add = `[mm|p${page}=x,y]`;
    return (text.endsWith('\n') ? text : text+'\n') + add + '\n';
  }

  function pagesFromMemo(text) {
    const toks = parseTokens(text), order=[], seen=new Set();
    for (const t of toks) if (!t.deleted && !seen.has(t.page)) { seen.add(t.page); order.push(t.page); }
    return [primaryPage, ...order.filter(p=>p!==primaryPage)];
  }

  function renderRefStrip() {
    const strip = $('#refstrip'); strip.innerHTML='';
    // numerically sorted, with primary included
    const list = pagesFromMemo($('#memoTA').value).sort((a,b)=>a-b);
    for (const p of list) {
      const ref = document.createElement('div');
      ref.className = 'ref' + (p===primaryPage?' primary':'') + (p===currentPage?' active':'');
      ref.dataset.page = p;
      const img = document.createElement('img');
      img.src = `/cafes/zeta-zero-cafe/sources/thumbs/page-${pad3(p)}.jpg`;
      img.alt = `p.${p}`;
      const badge = document.createElement('div'); badge.className='badge'; badge.textContent=`p.${p}`;
      const kill  = document.createElement('div'); kill.className='kill'; kill.textContent='×'; kill.title='Mark tokens as [del]';

      ref.append(img,badge,kill);
      ref.addEventListener('click', ev => { if (ev.target===kill) return; setCurrentPage(p); });
      kill.addEventListener('click', ev => { ev.stopPropagation(); if (p===primaryPage) return;
        const ta=$('#memoTA'); ta.value = markDeletedForPage(ta.value, p); onMemoChanged();
      });

      strip.appendChild(ref);
    }
    const active = strip.querySelector('.ref.active');
    if (active) active.scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'});
  }

  function renderChips() {
    const holder=$('#chips'); holder.innerHTML='';
    for (const t of parseTokens($('#memoTA').value)) {
      const c=document.createElement('span');
      c.className='chip' + (t.page===currentPage && !t.deleted ? ' hot' : '');
      c.textContent=(t.deleted?'[del] ':'') + `p${t.page}`;
      holder.appendChild(c);
    }
  }

  function setCurrentPage(p) {
    currentPage=Math.max(1,p);
    const img=$('#viewerImg');
    img.src = `/cafes/zeta-zero-cafe/sources/thumbs/page-${pad3(currentPage)}.jpg`;
    img.onload  = ()=>setStatus(`Loaded thumbnail p.${currentPage}.`);
    img.onerror = ()=>setStatus(`Missing thumbnail p.${currentPage}.`);
    renderRefStrip(); renderChips();
  }

  $('#btnPrev').addEventListener('click', ()=>setCurrentPage(currentPage-1));
  $('#btnNext').addEventListener('click', ()=>setCurrentPage(currentPage+1));
  $('#btnPrimary').addEventListener('click', ()=>setCurrentPage(primaryPage));
  $('#btnAdd').addEventListener('click', ()=>{
    if (currentPage===primaryPage) return;           // never add token for primary
    const ta=$('#memoTA'); ta.value = addTokenIfNeeded(ta.value, currentPage); onMemoChanged();
  });

  function onMemoChanged() {
    renderRefStrip(); renderChips();
    $('#renderOut').textContent = $('#memoTA').value.trim() || '—';
  }
  $('#memoTA').addEventListener('input', onMemoChanged);

  // fake button pings
  const ping = m => alert(m);
  $('#btnSaveDraft').onclick   = ()=>ping('Saving draft');
  $('#btnSaveVersion').onclick = ()=>ping('Saving version');
  $('#btnExportJSON').onclick  = ()=>ping('Exporting memo JSON');
  $('#btnExportAll').onclick   = ()=>ping('Export ALL drafts');
  $('#btnChoose').onclick      = ()=>ping('Choosing File');
  $('#btnDiscord').onclick     = ()=>ping('Submitting via Discord');

  (function init(){
    // ensure no default primary token is injected at start
    $('#memoTA').value = ($('#memoTA').value || '').replace(/\[mm\|p7\s*=[^\]]+\]\s*/g,'');
    setCurrentPage(primaryPage);
    onMemoChanged();
    $('#paraTag').textContent = '#osf-1';
    if (window.MathJax?.typesetPromise) window.MathJax.typesetPromise();
  })();
  </script>

  <!-- hidden hooks for test-only buttons (IDs required) -->
  <div style="display:none">
    <button id="btnSaveDraft"></button>
    <button id="btnSaveVersion"></button>
    <button id="btnExportJSON"></button>
    <button id="btnExportAll"></button>
    <button id="btnChoose"></button>
    <button id="btnDiscord"></button>
  </div>
</body>
</html>
