<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Source document</title>
  <link rel="stylesheet" href="/css/10-components/research-office.css"/>
  <style>
    body{background:#0d1117;color:#c9d1d9;font:14px/1.35 ui-sans-serif,system-ui,Segoe UI,Roboto,sans-serif;margin:0}
    header{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid #30363d}
    header .tag{background:#0b1420;border:1px solid #1f6feb;border-radius:999px;padding:4px 10px}
    .wrap{display:grid;grid-template-columns:300px 1fr;gap:12px;padding:12px}
    .thumbs{height:calc(100vh - 84px);overflow:auto;border:1px solid #30363d;border-radius:10px;padding:8px;background:#0b1020}
    .viewer{height:calc(100vh - 84px);overflow:auto;border:1px solid #30363d;border-radius:10px;display:flex;align-items:flex-start;justify-content:center;background:#0b1020}
    canvas{display:block}
    .thumb{margin:8px 6px;border-radius:8px;overflow:hidden;border:1px solid #30363d;cursor:pointer;position:relative}
    .thumb.active{box-shadow:0 0 0 2px #ffa657 inset;border-color:#ffa657}
    .toolbar{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:8px}
    .btn{background:#0b1420;border:1px solid #30363d;border-radius:10px;color:#c9d1d9;padding:6px 12px}
  </style>
  <!-- pdf.js (browser build) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/build/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/build/pdf.worker.min.js";
  </script>
</head>
<body>
<header>
  <button id="backBtn" class="btn">← Back</button>
  <span id="pdfName" class="tag"></span>
  <span id="linked" class="tag" style="opacity:.75"></span>
  <span style="flex:1"></span>
  <button id="openOriginal" class="btn">Open original</button>
  <button id="downloadBtn" class="btn">Download</button>
</header>

<div class="wrap">
  <div id="thumbs" class="thumbs"></div>
  <div id="viewer" class="viewer"><canvas id="pageCanvas"></canvas></div>
</div>

<div class="toolbar">
  <button id="prev" class="btn">Prev</button>
  <button id="next" class="btn">Next</button>
  <button id="zoomOut" class="btn">−</button>
  <button id="zoomIn" class="btn">+</button>
</div>

<script type="module">
(async () => {
  const $ = sel => document.querySelector(sel);
  const params = new URLSearchParams(location.search);
  const PDF_BN = (params.get('pdf') || 'Old_main').replace(/\.pdf$/i,'');
  const paraId = params.get('para') || '';
  const chapter = params.get('chapter') || '';
  const returnUrl = params.get('return') || document.referrer || '/';
  const slug = (() => {
    // current path like /cafes/zeta-zero-cafe/source.html
    const m = location.pathname.match(/^\/cafes\/([^/]+)/);
    return m ? m[1] : '';
  })();
  const cafeRoot = `/cafes/${slug}`;                 // /cafes/zeta-zero-cafe
  const pdfUrl   = `${cafeRoot}/sources/${PDF_BN}.pdf`;

  // try map at /data/cafes/<slug>/sources/<bn>.map.json, then <cafeRoot>/sources/...
  const mapUrls = [
    `/data/cafes/${slug}/sources/${PDF_BN}.map.json`,
    `${cafeRoot}/sources/${PDF_BN}.map.json`,
  ];

  // UI bits
  $('#pdfName').textContent = `${PDF_BN}.pdf`;
  $('#linked').textContent = paraId ? `Linked from ${paraId}` : '';
  $('#backBtn').onclick = e => { e.preventDefault(); returnUrl ? location.href = returnUrl : history.back(); };
  $('#openOriginal').onclick = () => window.open(pdfUrl, '_blank', 'noopener');
  $('#downloadBtn').onclick   = () => window.open(pdfUrl, '_blank', 'noopener');

  // fetch mapping (first that works)
  async function fetchFirst(urls){
    for (const u of urls){
      try{
        const r = await fetch(u, {cache:'no-cache'});
        if (r.ok) return await r.json();
      }catch(_){}
    }
    return null;
  }
  const map = await fetchFirst(mapUrls);

  function lookupTargetPage() {
    if (!map) return 1;
    // global offsets
    const meta = map.meta || {};
    const globalOffset = Number(meta.offset || 0);
    const perChapterOffset = (meta.offsets && chapter && meta.offsets[chapter]) ? Number(meta.offsets[chapter]) : 0;

    // chapter starts table (absolute page where a chapter begins)
    const starts = (meta.starts || {});
    // pick chapter block for per-paragraph mapping
    const chapterBlock = (chapter && map[chapter]) ? map[chapter] : null;

    // paragraph mapping wins if present
    if (chapterBlock && paraId && chapterBlock[paraId]) {
      const {from} = chapterBlock[paraId];
      return Math.max(1, Number(from) + globalOffset + perChapterOffset);
    }

    // otherwise: if we know the chapter start, use that as target
    if (chapter && starts[chapter] != null) {
      return Math.max(1, Number(starts[chapter]) + globalOffset + perChapterOffset);
    }
    return 1;
  }

  // pdf.js state
  let pdf = null, currentPage = 1, scale = 1.15;
  const canvas = $('#pageCanvas');
  const ctx = canvas.getContext('2d', {alpha:false});

  async function renderPage(n){
    currentPage = Math.min(Math.max(1,n), pdf.numPages);
    const page = await pdf.getPage(currentPage);
    const viewport = page.getViewport({scale});
    canvas.width = viewport.width|0;
    canvas.height = viewport.height|0;
    await page.render({canvasContext: ctx, viewport}).promise;

    // update active thumb
    for (const el of document.querySelectorAll('.thumb')) el.classList.remove('active');
    const t = document.querySelector(`.thumb[data-p="${currentPage}"]`);
    if (t){
      t.classList.add('active');
      t.scrollIntoView({block:'center'});
    }
  }

  async function buildThumbs(){
    const box = $('#thumbs');
    box.innerHTML = '';
    const thumbScale = 0.18;
    for (let i=1;i<=pdf.numPages;i++){
      const div = document.createElement('div');
      div.className = 'thumb'; div.dataset.p = String(i);

      const c = document.createElement('canvas');
      c.style.display='block';
      c.width = 480; c.height = 640; // will be resized by render
      div.appendChild(c);
      box.appendChild(div);

      div.onclick = () => renderPage(i);

      // render
      const page = await pdf.getPage(i);
      const vp = page.getViewport({scale: thumbScale});
      c.width = vp.width|0; c.height = (vp.height|0);
      page.render({canvasContext: c.getContext('2d', {alpha:false}), viewport: vp});
    }
  }

  // load pdf
  try{
    pdf = await pdfjsLib.getDocument({url: pdfUrl}).promise;
  }catch(e){
    console.error('Failed to load PDF', e, pdfUrl);
    alert(`Failed to load PDF (Missing PDF): ${pdfUrl}`);
    return;
  }

  await buildThumbs();

  const targetPage = lookupTargetPage();
  await renderPage(targetPage);

  // nav
  $('#prev').onclick    = () => renderPage(currentPage-1);
  $('#next').onclick    = () => renderPage(currentPage+1);
  $('#zoomIn').onclick  = async () => { scale = Math.min(scale+0.1, 3.0); await renderPage(currentPage); };
  $('#zoomOut').onclick = async () => { scale = Math.max(scale-0.1, 0.4); await renderPage(currentPage); };

})();
</script>
</body>
</html>
