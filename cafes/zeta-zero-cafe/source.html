<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Source document</title>
  <link rel="stylesheet" href="/css/10-components/research-office.css">
  <style>
    body{background:#0d1117;color:#e6edf3;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .bar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .btn{background:#161b22;border:1px solid #30363d;padding:6px 10px;border-radius:8px;color:#e6edf3;text-decoration:none}
    .btn:hover{background:#1f242d}
    .badge{font-size:.8rem;opacity:.8;border:1px solid #30363d;border-radius:999px;padding:2px 8px}
    .cols{display:grid;grid-template-columns:280px 1fr;gap:16px}
    .thumbs{background:#0b0f14;border:1px solid #30363d;border-radius:12px;padding:12px;height:70vh;overflow:auto}
    .viewer{background:#0b0f14;border:1px solid #30363d;border-radius:12px;padding:12px;height:70vh;overflow:auto;position:relative}
    canvas{display:block;margin:0 auto}
    .controls{display:flex;gap:8px;margin-top:8px}
    .thumb{margin:8px 0;border:1px solid #30363d;border-radius:8px;overflow:hidden;cursor:pointer}
    .thumb.active{box-shadow:0 0 0 2px #1f6feb inset}
    .thumb canvas{width:100% !important;height:auto !important}
    .hl{position:absolute;left:8px;top:8px;background:#1f6feb22;border:1px solid #1f6feb;border-radius:6px;padding:2px 6px;font-size:.8rem}
  </style>
  <!-- PDF.js from unpkg (works on GH Pages and localhost) -->
  <script src="https://unpkg.com/pdfjs-dist@4.10.38/build/pdf.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <a id="backBtn" class="btn" href="javascript:history.back()">← Back</a>
      <span id="pdfName" class="btn badge"></span>
      <span id="linkedFrom" class="btn badge">Linked from <span id="fromTag">—</span></span>
      <a id="openOriginal" class="btn" target="_blank" rel="noopener">Open original</a>
      <a id="downloadPdf" class="btn" download>Download</a>
    </div>

    <div class="cols">
      <div class="thumbs" id="thumbs"></div>
      <div class="viewer" id="viewer">
        <div class="hl" id="hl" style="display:none"></div>
        <canvas id="pageCanvas"></canvas>
      </div>
    </div>

    <div class="controls">
      <button class="btn" id="prevBtn">Prev</button>
      <button class="btn" id="nextBtn">Next</button>
      <button class="btn" id="zoomOut">−</button>
      <button class="btn" id="zoomIn">+</button>
    </div>
  </div>

<script>
(async () => {
  // ---------- Query & path helpers ----------
  const u = new URL(location.href);

  const pdfbnRaw = (u.searchParams.get("pdf") || "Old_main").replace(/\.pdf$/i,"");
  const paraRaw = u.searchParams.get("para") || "";
  const chapter = decodeURIComponent(u.searchParams.get("chapter") || "");
  const returnUrl = u.searchParams.get("return") || document.referrer || "/";
  const fromQP = u.searchParams.get("from");
  const toQP   = u.searchParams.get("to");

  // Extract /cafes/<slug>/... safely (works on GH Pages and localhost)
  const m = location.pathname.match(/^\/cafes\/([^\/]+)/);
  const slug = m ? m[1] : "zeta-zero-cafe";
  const cafeRoot = `/cafes/${slug}`;

  // Absolute URLs (avoid relative double "/cafes/cafes" bugs)
  const pdfUrl = `${cafeRoot}/sources/${pdfbnRaw}.pdf`;
  const mapUrl = `/data/cafes/${slug}/sources/${pdfbnRaw}.map.json`;

  // UI labels
  document.getElementById("pdfName").textContent = `${pdfbnRaw}.pdf`;
  document.getElementById("fromTag").textContent = paraRaw || "—";
  document.getElementById("openOriginal").href = pdfUrl;
  document.getElementById("downloadPdf").href = pdfUrl;
  document.getElementById("downloadPdf").download = `${pdfbnRaw}.pdf`;
  document.getElementById("backBtn").onclick = (e)=>{
    e.preventDefault();
    if (returnUrl) location.href = returnUrl; else history.back();
  };

  // ---------- Mapping resolution ----------
  function normalizePara(p){
    if (!p) return "";
    // accept osf-1, osf-01, osf-001 → zero-pad to 3 for stable keys
    const m = p.match(/^osf-(\d+)$/i);
    if (!m) return p;
    const n = m[1].padStart(3,"0");
    return `osf-${n}`;
  }

  const paraKey = normalizePara(paraRaw);

  let targetPage = 1;
  let highlight = null;

  async function resolveMapping(){
    // Explicit override wins
    if (fromQP) {
      const f = Math.max(1, parseInt(fromQP,10)||1);
      const t = Math.max(f, parseInt(toQP||fromQP,10)||f);
      targetPage = f;
      highlight = {from:f, to:t};
      return;
    }
    try{
      const res = await fetch(mapUrl, {cache:"no-store"});
      if (!res.ok) return;
      const map = await res.json();

      // meta: starts, offset, offsets
      const meta = map.meta || {};
      const starts = meta.starts || {};
      const globalOffset = +meta.offset || 0;
      const chapterOffset = (meta.offsets && +meta.offsets[chapter]) || 0;

      // chapter block present?
      let hit = null;
      if (chapter && map[chapter]) {
        const block = map[chapter];
        if (paraKey && block[paraKey]) {
          hit = block[paraKey];
        }
      }
      if (hit) {
        targetPage = +hit.from || 1;
        highlight = {from:+hit.from, to:+hit.to || +hit.from || 1};
      } else if (starts[chapter]) {
        targetPage = +starts[chapter] || 1;
      }

      // apply offsets
      targetPage = Math.max(1, targetPage + globalOffset + chapterOffset);
      if (highlight) {
        highlight.from = Math.max(1, (highlight.from||targetPage) + globalOffset + chapterOffset);
        highlight.to   = Math.max(highlight.from, (highlight.to||highlight.from) + globalOffset + chapterOffset);
      }
    } catch (e) {
      // No mapping available; keep defaults
    }
  }

  await resolveMapping();

  // ---------- PDF.js setup ----------
  const pdfjsLib = window['pdfjsLib'];
  // Use the official worker (CDN path), avoids worker 404s on Pages
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://unpkg.com/pdfjs-dist@4.10.38/build/pdf.worker.min.js";

  const loadingTask = pdfjsLib.getDocument(pdfUrl);
  let pdf;
  try{
    pdf = await loadingTask.promise;
  } catch (e) {
    alert(`Failed to load PDF (Missing PDF): ${pdfUrl}`);
    return;
  }

  const thumbsEl = $("#thumbs");
  const canvas = $("#pageCanvas");
  const ctx = canvas.getContext("2d");
  const viewer = $("#viewer");
  const hlEl = $("#hl");

  let scale = 1.2;
  let current = Math.min(Math.max(1, targetPage), pdf.numPages);

  // ---------- helpers ----------
  function $(sel){ return document.querySelector(sel); }
  function make(el, cls){ const e=document.createElement(el); if(cls) e.className=cls; return e; }

  async function renderPage(pageNum){
    const page = await pdf.getPage(pageNum);
    const vp = page.getViewport({scale});
    canvas.width = vp.width;
    canvas.height = vp.height;
    const renderContext = {canvasContext:ctx, viewport:vp};
    await page.render(renderContext).promise;

    if (highlight && pageNum >= (highlight.from||0) && pageNum <= (highlight.to||0)) {
      hlEl.style.display = "block";
      hlEl.textContent = `§ ${paraRaw || ""} · p.${pageNum}`;
    } else {
      hlEl.style.display = "none";
    }
    // Mark active thumb
    document.querySelectorAll(".thumb").forEach(t=>t.classList.toggle("active", +t.dataset.p===pageNum));
  }

  async function buildThumbs(){
    thumbsEl.innerHTML = "";
    const maxThumbs = Math.min(pdf.numPages, 126); // cap for perf, but show a lot
    for (let i=1;i<=maxThumbs;i++){
      const page = await pdf.getPage(i);
      // tiny scale for thumbs
      const vp = page.getViewport({scale:0.25});
      const c = make("canvas");
      c.width = vp.width;
      c.height = vp.height;
      await page.render({canvasContext:c.getContext("2d"), viewport:vp}).promise;
      const wrap = make("div","thumb");
      wrap.dataset.p = i;
      wrap.appendChild(c);
      wrap.onclick = ()=>{ current=i; renderPage(current); };
      thumbsEl.appendChild(wrap);
    }
    // nudge into view near the target/highlight band if we have one
    const anchor = document.querySelector(`.thumb[data-p="${current}"]`);
    if (anchor) {
      const y = Math.max(anchor.offsetTop - 80, 0);
      thumbsEl.scrollTo({top:y, behavior:"instant"});
      anchor.classList.add("active");
    }
  }

  // ---------- controls ----------
  $("#prevBtn").onclick = ()=>{ if (current>1){ current--; renderPage(current);} };
  $("#nextBtn").onclick = ()=>{ if (current<pdf.numPages){ current++; renderPage(current);} };
  $("#zoomOut").onclick = ()=>{ scale = Math.max(0.5, scale-0.1); renderPage(current); };
  $("#zoomIn").onclick  = ()=>{ scale = Math.min(2.4,  scale+0.1); renderPage(current); };

  // ---------- go ----------
  await buildThumbs();
  await renderPage(current);
})();
</script>
</body>
</html>
