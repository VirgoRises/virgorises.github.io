<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Research Office</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Styles -->
  <link rel="stylesheet" href="/css/10-components/research-office.css" />

  <!-- MathJax v3 (SVG) for TeX in previews -->
  <script>
    // Allow $...$ and \( ... \) inline; $$...$$ and \[ ... ] display.
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'code'] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="head">
      <h1 class="ro-title" style="margin:0;">
        Research Office — <span id="cafeName" class="tag">zeta-zero-cafe</span>
        <span id="chapName" class="muted ro-sub" style="margin-left:.5rem"></span>
      </h1>
      <a id="backLink" class="btn" href="#">← Back</a>
    </div>

    <div class="row">
      <!-- Left: paragraph preview + pick lists -->
      <div class="card">
        <div class="head">
          <strong>Paragraph preview</strong>
          <span id="paraNum" class="tag">#</span>
        </div>

        <pre id="paraPreview" class="card preview"></pre>

        <!-- Backdrop stage: PDF canvas or image sits under this, SVG grid overlays it -->
        <div id="ro-stage" class="card" style="margin-top:12px">
          <img id="ro-page" src="" alt="source page" />
        </div>

        <div class="split" style="margin-top:12px">
          <div>
            <div class="head"><strong>Figures</strong></div>
            <div id="figList" class="list"></div>
          </div>
          <div>
            <div class="head"><strong>Tables</strong></div>
            <div id="tblList" class="list"></div>
          </div>
        </div>

        <div class="bar">
          <button id="copyLink" class="btn">Copy link</button>
        </div>
        <div class="muted" style="margin-top:8px">
          Tip: toggle “member” in any chapter popover to show/hide the app button.
        </div>
      </div>

      <!-- Right: memo editor -->
      <div class="card">
        <div class="head"><strong>Memo to self (Markdown/LaTeX)</strong></div>
        <textarea id="memoBody" placeholder="State the issue, desired change, and rationale..."></textarea>
        <div class="bar">
          <button id="saveDraft" class="btn">Save draft (browser)</button>
          <button id="exportJson" class="btn">Export JSON</button>
          <button id="submitDiscord" class="btn">Submit via Discord</button>
        </div>
        <div class="muted" style="margin-top:8px">
          RFCs are processes, not chats. Draft → step away → revise → then submit.
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="head"><strong>Recent drafts (this browser)</strong></div>
      <div id="memoList" class="list"></div>
    </div>
  </div>

  <!-- App logic (preview + lists + memo) -->
  <script defer src="/js/research.office.js?v=2025-10-11a"></script>

  <!-- Grid/backdrop module (single init) -->
  <script type="module">
    import { initResearchOfficeGrid } from "/js/research-office-grid.js";

    const Q = new URLSearchParams(location.search);
    const PARA    = Q.get("para")    || "osf-1";
    const CHAPTER = Q.get("chapter") || "";
    const EXPL_FROM = Number(Q.get("from") || "0");

    // Optional: resolve missing &from via your data (overrides → map)
    async function resolveFromPage(docId, chapter, anchor) {
      const base = "/data/cafes/zeta-zero-cafe/sources";
      const [overrides, map] = await Promise.all([
        fetch(`${base}/${docId}.overrides.json`, { cache: "no-store" }).then(r => r.ok ? r.json() : null).catch(()=>null),
        fetch(`${base}/${docId}.map.json`,       { cache: "no-store" }).then(r => r.ok ? r.json() : null).catch(()=>null),
      ]);

      const block = (root) => root?.chapters?.[chapter] && (root.chapters[chapter].items || root.chapters[chapter]) || null;
      const pick  = (obj) => obj?.[anchor] ?? obj?.[`para-${anchor}`] ?? null;
      const norm  = (rec) => rec
        ? (typeof rec.page === "number" ? {from:rec.page,to:rec.page}
           : (typeof rec.from === "number" && typeof rec.to === "number" ? {from:rec.from,to:rec.to} : null))
        : null;

      const o = norm(pick(block(overrides))); if (o) return o.from;
      const d = norm(pick(block(map)));       if (d) return d.from;
      return 0;
    }

    (async () => {
      const FROM = EXPL_FROM || await resolveFromPage("Old_main", CHAPTER, PARA);

      initResearchOfficeGrid({
        para: PARA,
        chapter: CHAPTER,
        fromPage: FROM,
        // If you have static images, you can provide:
        // pageToUrl: (p) => `/cafes/zeta-zero-cafe/thumbs/page-${p}.jpg`,
        // Otherwise render straight from the PDF:
        pdfUrl: "/cafes/zeta-zero-cafe/sources/Old_main.pdf",
        initialZoom: "fit"
      });
    })();
  </script>
</body>
</html>
