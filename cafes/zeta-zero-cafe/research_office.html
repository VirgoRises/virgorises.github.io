<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Research Office</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Styles -->
  <link rel="stylesheet" href="/css/10-components/research-office.css" />

  <!-- MathJax v3 (SVG) for TeX in previews -->
  <script>
    // Allow $...$ and \( ... \) inline; $$...$$ and \[ ... ] display.
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'code'] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="head">
      <h1 class="ro-title" style="margin:0;">
        Research Office — <span id="cafeName" class="tag">zeta-zero-cafe</span>
        <span id="chapName" class="muted ro-sub" style="margin-left:.5rem"></span>
      </h1>
      <a id="backLink" class="btn" href="#">← Back</a>
    </div>

    <div class="row">
      <!-- Left: paragraph preview + pick lists -->
      <div class="card">
        <div class="head">
          <strong>Paragraph preview</strong>
          <span id="paraNum" class="tag">#</span>
        </div>

        <pre id="paraPreview" class="card preview"></pre>

        <!-- Backdrop stage: PDF canvas or image sits under this, SVG grid overlays it -->
        <div id="ro-stage" class="card" style="margin-top:12px">
          <img id="ro-page" src="" alt="source page" />
        </div>

        <div class="split" style="margin-top:12px">
          <div>
            <div class="head"><strong>Figures</strong></div>
            <div id="figList" class="list"></div>
          </div>
          <div>
            <div class="head"><strong>Tables</strong></div>
            <div id="tblList" class="list"></div>
          </div>
        </div>

        <div class="bar">
          <button id="copyLink" class="btn">Copy link</button>
        </div>
        <div class="muted" style="margin-top:8px">
          Tip: toggle “member” in any chapter popover to show/hide the app button.
        </div>
      </div>

      <!-- Right: memo editor -->
      <div class="card">
        <div class="head"><strong>Memo to self (Markdown/LaTeX)</strong></div>
        <textarea id="memoBody" placeholder="State the issue, desired change, and rationale..."></textarea>
        <div class="bar">
          <button id="saveDraft" class="btn">Save draft (browser)</button>
          <button id="exportJson" class="btn">Export JSON</button>
          <button id="submitDiscord" class="btn">Submit via Discord</button>
        </div>
        <div class="muted" style="margin-top:8px">
          RFCs are processes, not chats. Draft → step away → revise → then submit.
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="head"><strong>Recent drafts (this browser)</strong></div>
      <div id="memoList" class="list"></div>
    </div>
  </div>

  <!-- App logic (preview + lists + memo) -->
  <script defer src="/js/research.office.js?v=2025-10-11a"></script>

  <!-- Grid/backdrop module (single init) -->
<script type="module">
  import { initResearchOfficeGrid } from "/js/research-office-grid.js";

  const qs      = new URLSearchParams(location.search);
  const para    = qs.get("para")    || "osf-1";
  const chapter = qs.get("chapter") || "";
  const forced  = Number(qs.get("from") || "0");

  async function resolveFrom(chapterId, anchorId) {
    const base = "/data/cafes/zeta-zero-cafe/sources";
    try {
      const [ov, mp] = await Promise.all([
        fetch(`${base}/Old_main.overrides.json`).then(r => r.ok ? r.json() : {}),
        fetch(`${base}/Old_main.map.json`).then(r => r.ok ? r.json() : {}),
      ]);
      const o = ov?.chapters?.[chapterId]?.items?.[anchorId];
      if (o?.page != null) return Number(o.page);
      const d = mp?.chapters?.[chapterId]?.items?.[anchorId];
      if (d?.from != null) return Number(d.from);
    } catch (e) {
      console.warn("resolveFrom failed", e);
    }
    return 0;
  }

  (async () => {
    const fromPage = forced > 0 ? forced : await resolveFrom(chapter, para);
    initResearchOfficeGrid({
      para, chapter,
      fromPage,                                  // always passed
      pdfUrl: "/cafes/zeta-zero-cafe/sources/Old_main.pdf",
      initialZoom: "fit",
    });
  })();
</script>

<!-- HUD (non-invasive). Keep AFTER the module block -->
<script src="/js/research-office-hud.js"></script>

</body>

</html>