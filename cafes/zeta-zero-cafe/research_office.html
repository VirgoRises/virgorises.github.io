<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Research Office ‚Äî zeta-zero-cafe</title>

  <!-- Scoped stylesheet for this page -->
  <link rel="stylesheet" href="/css/10-components/research-office.css"/>

  <!-- Use the same MathJax config as chapter pages -->
  <script src="/cafes/zeta-zero-cafe/notebook/math/mathconfig.js"></script>
</head>
<body class="ro">
  <header class="ro-head">
    <a class="ro-back" href="javascript:history.back()">‚Üê Back</a>
    <h1>Research Office ‚Äî <span class="mono">zeta-zero-cafe</span></h1>
  </header>

  <main class="ro-main">
    <!-- LEFT: fixed 6cm page, toolbar above -->
    <section class="left">
      <div id="ro-toolbar" class="toolbar">
        <div class="btns">
          <button id="toolPoint" type="button">Point</button>
          <button id="toolBox"   type="button">Box</button>
        </div>
        <div class="btns">
          <span>Zoom:</span>
          <button id="zoomOut" type="button">‚Äì</button>
          <button id="zoomFit" type="button">Fit</button>
          <button id="zoomIn"  type="button">+</button>
        </div>
        <div class="btns">
          <label>Units:
            <select id="unitsSel">
              <option value="mm" selected>mm</option>
            </select>
          </label>
          <button id="exportJson" type="button">Export JSON</button>
        </div>
      </div>

      <div id="ro-stage" class="card">
        <div id="ro-inner">
          <img id="ro-page" alt="source page"/>
          <svg id="ro-svg" aria-hidden="true"></svg>
        </div>
      </div>

      <div id="token" class="tiny mono muted">click marker to copy</div>
    </section>

    <!-- RIGHT: MM thumbnails ‚Üí paragraph preview ‚Üí memo -->
    <section class="right">
      <!-- Thumbnails extracted from memo [mm|pNN‚Ä¶] -->
      <div class="card" id="mmThumbsCard">
        <div class="card-h">Pages referenced in memo</div>
        <div id="mmThumbs" class="mm-thumbs muted tiny">No page references yet.</div>
      </div>

      <!-- Paragraph preview -->
      <div class="card" id="paraCard">
        <div class="card-h">
          <strong>Paragraph preview</strong>
          <span id="paraNum" class="tag">#</span>
        </div>
        <div id="paraPreview" class="para-preview"></div>
        <div id="paraFoot" class="tiny mono muted"></div>
      </div>

      <!-- Memo -->
      <div class="card">
        <div class="card-h">Memo to self (Markdown + LaTeX)</div>
        <div class="toolbar slim">
          <div class="btns">
            <button data-md="**|**"><b>B</b></button>
            <button data-md="_|_"><i>i</i></button>
            <button data-md="`|`">{}</button>
            <button data-md="[|]()">üîó</button>
            <button data-md="$$|$$">\\(x\\)</button>
            <button id="memoPreview" type="button">Preview</button>
          </div>
        </div>
        <textarea id="memo" rows="10" placeholder="State the issue, desired change, and rationale..."></textarea>
        <div class="btnrow">
          <button id="saveDraft">Save draft</button>
          <button id="saveVersion">Save version</button>
          <button id="exportMemo">Export memo JSON</button>
          <button id="exportAll">Export ALL drafts</button>
          <label class="file">
            <input id="importMemo" type="file" accept="application/json"/>
            Choose File
          </label>
          <button id="submitDiscord">Submit via Discord</button>
        </div>
        <div class="tiny muted">
          Autosave is ON (on every keystroke + periodically). Draft ‚Üí step away ‚Üí revise ‚Üí submit.
        </div>
      </div>

      <div class="card">
        <div class="card-h">Versions (snapshots for this memo)</div>
        <div id="versions" class="tiny muted">No snapshots yet.</div>
      </div>

      <div class="card">
        <div class="card-h">Recent drafts (this browser)</div>
        <div id="recentDrafts" class="tiny muted">‚Äî</div>
      </div>
    </section>
  </main>

  <!-- Grid/HUD & page plumbing -->
  <script src="/js/research-office-grid.js"></script>
  <script src="/js/research.office.js"></script>

  <!-- Bootstrap & MM thumbnails logic -->
  <script>
    (async function () {
      const qs = new URLSearchParams(location.search);
      const fromPage = Number(qs.get('from') || '0') || 0;
      const chapter  = qs.get('chapter') || '';
      const para     = qs.get('para') || '';

      // Init grid at fixed 6 cm baseline using thumbnails
      if (window.initResearchOfficeGrid) {
        window.initResearchOfficeGrid({
          fromPage,
          para,
          chapter,
          thumbsBase: '/cafes/zeta-zero-cafe/sources/thumbs',
          pageMM: { w: 210, h: 297 },  // A4 default; grid flips if landscape
          units: 'mm'
        });
      }

      // Paragraph preview
      if (window.loadParagraphPreview) window.loadParagraphPreview();

      // Keep right-side blocks aligned to stage height
      function syncRightHeights () {
        const st = document.getElementById('ro-stage');
        if (!st) return;
        document.documentElement.style.setProperty('--ro-stage-h', st.clientHeight + 'px');
      }
      syncRightHeights();
      new ResizeObserver(syncRightHeights).observe(document.getElementById('ro-stage'));

      // MM thumbnails from memo: [mm|pNN...]
      const memoEl = document.getElementById('memo');
      const thumbsEl = document.getElementById('mmThumbs');
      const base = '/cafes/zeta-zero-cafe/sources/thumbs';

      function pad3(n){return String(n).padStart(3,'0');}
      function pagesFromMemo(txt){
        const pages = new Set();
        const re = /\[mm\|p(\d+)(?::[\d\.,]+(?:;[\d\.,]+)*)?\]/gi;
        let m; while((m=re.exec(txt))) pages.add(Number(m[1]));
        return [...pages].sort((a,b)=>a-b);
      }
      function renderThumbs(){
        const pages = pagesFromMemo(memoEl.value || '');
        if (!pages.length) { thumbsEl.textContent = 'No page references yet.'; return; }
        thumbsEl.innerHTML = '';
        for (const p of pages){
          const a = document.createElement('a');
          a.className = 'mm-thumb';
          a.title = 'Go to page '+p;
          a.href = updateFromInUrl(location.href, p);
          const img = document.createElement('img');
          img.loading = 'lazy';
          img.src = `${base}/page-${pad3(p)}.jpg`;
          img.alt = `p.${p}`;
          a.appendChild(img);
          const cap = document.createElement('div');
          cap.textContent = `p.${p}`;
          a.appendChild(cap);
          thumbsEl.appendChild(a);
        }
      }
      function updateFromInUrl(url, p){
        const u = new URL(url, location.href);
        u.searchParams.set('from', String(p));
        return u.toString();
      }

      memoEl.addEventListener('input', renderThumbs);
      renderThumbs();
    })();
  </script>
</body>
</html>
